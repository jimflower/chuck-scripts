#!/usr/bin/env bash
# Chuck Scripts — NetworkChuck-style launcher for 40 tools (Debian/Ubuntu/RPi OS)
# (*) shows if the main binary looks installed.
set -euo pipefail

# Package helpers -------------------------------------------------------------
PKG_REFRESH="sudo apt-get update -y"
PKG_INSTALL="sudo apt-get install -y"

have() { command -v "$1" >/dev/null 2>&1; }
pkg_install() {
  local pkgs="${1:-}" notes="${2:-}"
  if [[ -z "$pkgs" ]]; then
    echo "[INFO] Nothing to install (coreutils/manual or already present)."
    [[ -n "$notes" ]] && echo "$notes"
    return 0
  fi
  if [[ "$pkgs" == "(manual)" ]]; then
    echo "[MANUAL INSTALL]" ; [[ -n "$notes" ]] && echo "$notes"
    return 0
  fi
  echo "[INFO] Installing: $pkgs"
  $PKG_REFRESH >/dev/null || true
  if ! $PKG_INSTALL $pkgs; then
    echo
    echo "[WARN] apt install failed."
    [[ -n "$notes" ]] && echo "Notes: $notes"
  fi
}

# ---- Catalog: cmd|apt-pkgs|example|description|notes ----
CATALOG="$(cat <<'EOF'
ncdu|ncdu|ncdu /|TUI disk usage explorer.|
duff|duff|duff -r .|Find duplicate files by content (hash).|
ripgrep (rg)|ripgrep|rg -n "pattern" .|Blazing-fast grep replacement.|
mosh|mosh|mosh user@host|Roaming SSH shell over UDP; resilient.|
lshw|lshw|sudo lshw -short|Hardware lister (devices/slots/mem).|
mtr|mtr-tiny mtr|mtr -rw 1.1.1.1|Live ping+traceroute combo.|
fd (fdfind)|fd-find|fdfind README|Fast, friendly find (Debian=fdfind).|
fzf|fzf|fzf --help|Fuzzy finder for files/commands/history.|
ranger|ranger|ranger .|Lightning TUI file manager.|
zoxide (z)|zoxide|z foo|Smart cd/jump to frequent dirs.|
exa (use eza)|eza|eza -la|Modern ls (exa successor; apt package: eza).|
glances|glances|glances|All-in-one live system monitor.|
iotop|iotop|sudo iotop -oPa|Show top disk I/O by process.|
stat (coreutils)||stat -c "%n %s bytes %y" /bin/bash|File metadata details.|Coreutils (already installed).
dstat|dstat|dstat -cdnm --top-io --top-mem|Versatile vmstat/iostat/ifstat.|
watch|procps|watch -n 1 'ip -br link'|Rerun a command on an interval.|
progress|progress|watch -n1 progress -w|See cp/mv/dd progress of other procs.|
dig|dnsutils|dig A example.com|Classic DNS query client.|
dog|(manual)|dog example.com|Modern ‘dig’ with DoH/DoT.|Snap: sudo apt -y install snapd && sudo snap install dog
tcpdump|tcpdump|sudo tcpdump -ni any -c 50|CLI packet capture (pcap).|
tshark|tshark|sudo tshark -i any -c 50|Wireshark CLI engine.|
termshark|termshark|termshark -r file.pcap|TUI Wireshark (needs tshark).|If apt missing: go install github.com/gcla/termshark/v2/cmd/termshark@latest
lsof|lsof|sudo lsof -iTCP -sTCP:LISTEN|List open files/sockets.|
ipcalc|ipcalc|ipcalc 10.2.4.163/28|Subnet math helper.|
wormhole|magic-wormhole|wormhole send file.zip|Send files P2P with short codes.|
systemd-analyze blame|systemd|systemd-analyze blame|Boot time per service.|
systemd-analyze critical-chain|systemd|systemd-analyze critical-chain|Boot dependency timings.|
ps|procps|ps aux --sort=-%cpu | head|Classic process list.|
procs|procs|procs --watch|Colorful modern ps with grouping.|
lazydocker|(manual)|lazydocker|TUI for Docker.|Install: curl -fsSL https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
rsync|rsync|rsync -av --progress src/ dest/|Rock-solid copy/sync (SSH too).|
rm (coreutils)||rm -i file|Remove files; -i prompts (safer).|Coreutils; use carefully.
shred (coreutils)||shred -n 3 -vz file|Overwrite to securely remove.|Coreutils; SSD caveats apply.
moreutils|moreutils|ts '%.T' < /var/log/syslog | head|Toolkit: ts, errno, ifdata, vidir, vipe…|
ts (moreutils)|moreutils|seq 3 | ts|Timestamp each input line.|
errno (moreutils)|moreutils|errno 111|Explain errno codes.|
ifdata (moreutils)|moreutils|ifdata -p -i eth0 ipaddr|Quick iface info.|
vidir (moreutils)|moreutils|vidir .|Bulk rename via $EDITOR.|
vipe (moreutils)|moreutils|echo hi | vipe | tee out.txt|Drop your editor into a pipeline.|
unp|unp|unp archive.zip|Extract many archive types.|
jq|jq|jq '.' file.json|Swiss-army JSON processor.|
taskwarrior|taskwarrior|task add demo && task next|CLI task manager.|
asciinema|asciinema|asciinema rec|Record/share terminal sessions.|
fabric (fab)|python3-fabric|fab -V|Python remote exec CLI.|
ollama|(manual)|ollama run llama3:8b|Local LLM runner/manager.|Install: curl -fsSL https://ollama.com/install.sh | sh
EOF
)"

# Parse catalog into arrays (no read -d '')
mapfile -t LINES <<<"$CATALOG"
CMDS=(); PKGS=(); EXAMPLES=(); DESCS=(); NOTES=()
for line in "${LINES[@]}"; do
  [[ -z "$line" ]] && continue
  IFS='|' read -r cmd pkgs ex desc notes <<<"$line"
  CMDS+=("$cmd"); PKGS+=("${pkgs:-}"); EXAMPLES+=("${ex:-}")
  DESCS+=("${desc:-}"); NOTES+=("${notes:-}")
done

bin_hint() {
  local cmd="$1"
  case "$cmd" in
    "fd (fdfind)") echo "fdfind" ;;
    "exa (use eza)") echo "eza" ;;
    "ts (moreutils)"|"errno (moreutils)"|"ifdata (moreutils)"|"vidir (moreutils)"|"vipe (moreutils)")
      echo "${cmd%% *}" ;;
    "systemd-analyze blame"|"systemd-analyze critical-chain")
      echo "systemd-analyze" ;;
    "fabric (fab)") echo "fab" ;;
    *) echo "${cmd%% *}" ;;
  esac
}

show_menu() {
  clear
  echo "=== Chuck Scripts ==="
  echo "Commands from the video (Debian/RPi friendly)"
  echo
  for i in "${!CMDS[@]}"; do
    num=$((i+1))
    hint="$(bin_hint "${CMDS[$i]}")"
    mark=""; have "$hint" && mark="*"
    printf "%2d) %-30s %s\n" "$num" "${CMDS[$i]}" "$mark"
  done
  echo " I) Bulk install (apt-set)"
  echo " Q) Quit"
  echo
  echo "(*) binary detected"
  echo
}

detail() {
  local idx="$1"
  local cmd="${CMDS[$idx]}"
  local pkgs="${PKGS[$idx]}"
  local ex="${EXAMPLES[$idx]}"
  local desc="${DESCS[$idx]}"
  local notes="${NOTES[$idx]}"

  clear
  echo "== $cmd =="
  echo "$desc"
  [[ -n "$notes" ]] && { echo; echo "Notes:"; echo "  $notes"; }
  echo
  echo "Apt packages: ${pkgs:-(coreutils/manual)}"
  [[ -n "$ex" ]] && { echo "Example:"; echo "  $ex"; }
  echo
  echo "[I] Install   [R] Run example   [B] Back"
  read -rp "> " a
  case "${a^^}" in
    I) pkg_install "${pkgs:-}" "${notes:-}"; read -rp "Enter to continue..." ;;
    R) echo; echo "\$ $ex"; echo "-----------------------------------------"; bash -lc "$ex" || true; echo "-----------------------------------------"; read -rp "Enter to continue..." ;;
    *) ;;
  esac
}

bulk_install() {
  clear
  echo "== Bulk apt install =="
  local SET="ncdu duff ripgrep mosh lshw mtr-tiny fd-find fzf ranger zoxide eza glances iotop dstat procps progress dnsutils tcpdump tshark termshark lsof ipcalc magic-wormhole systemd procs rsync moreutils unp jq taskwarrior asciinema python3-fabric"
  echo "$SET" | fmt -w 80
  echo
  read -rp "Proceed? [y/N] " y
  [[ "${y,,}" == "y" ]] || return 0
  pkg_install "$SET"
  echo
  echo "[Manual installs to consider later:]"
  echo "  dog  → snapd + 'sudo snap install dog'"
  echo "  lazydocker → upstream install script"
  echo "  ollama → curl | sh from ollama.com"
  read -rp "Enter to continue..."
}

# Main loop
while :; do
  show_menu
  read -rp "Select number, I, or Q: " sel
  case "${sel^^}" in
    Q) exit 0 ;;
    I) bulk_install ;;
    *) if [[ "$sel" =~ ^[0-9]+$ ]] && (( sel>=1 && sel<=${#CMDS[@]} )); then detail $((sel-1)); fi ;;
  esac
done
EOS

# 3) Make executable
sudo chmod +x /usr/local/bin/chuck-menu
